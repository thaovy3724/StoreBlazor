@inject Blazored.SessionStorage.ISessionStorageService SessionStorage
@inject IJSRuntime JS
@inject NavigationManager NavigationManager

<!-- Topbar -->
<div class="topbar">
        <a href="/admin" class="fw-bold text-decoration-none" style="color:#0d6efd">
            Admin Panel
        </a>
        <div class="d-flex align-items-center">
        <span class="user-info me-2">Xin chào, 
            <a href="/admin/profile" class="fw-bold text-decoration-none" style="color:#0d6efd">
                @adminName
            </a>
        </span>
        <span class="text-muted mx-2">|</span>
        <button type="button" class="btn btn-link btn-sm p-0 text-decoration-none" style="color:#0d6efd" @onclick="LogoutAsync">Đăng xuất</button>
    </div>
</div>

@code {
    private string adminName = "Khách";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var name = await SessionStorage.GetItemAsync<string>("adminName");
            if (!string.IsNullOrEmpty(name))
            {
                adminName = name;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ERROR] Load admin name - {ex.Message}");
        }
    }

    private async Task LogoutAsync()
    {
        var confirmed = await JS.InvokeAsync<bool>("showLockAlert", "Xác nhận đăng xuất?");
        
        if (confirmed)
        {
            try
            {
                // Xóa tất cả session data
                await SessionStorage.RemoveItemAsync("adminId");
                await SessionStorage.RemoveItemAsync("adminName");
                await SessionStorage.RemoveItemAsync("adminEmail");
                await SessionStorage.RemoveItemAsync("adminRole");

                await JS.InvokeVoidAsync("showAlert", "Đăng xuất thành công.", "success");
                
                // Điều hướng về trang đăng nhập
                await Task.Delay(1500);
                NavigationManager.NavigateTo("/admin/login", forceLoad: true);
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("showAlert", $"Có lỗi xảy ra: {ex.Message}", "error");
                Console.WriteLine($"[ERROR] LogoutAsync - {ex}");
            }
        }
    }
}
