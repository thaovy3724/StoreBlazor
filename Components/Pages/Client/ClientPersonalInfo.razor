@page "/client/profile"
@layout ClientLayout
@inject IPersonalInfoService personalInfoService
@inject NavigationManager Nav
@inject Blazored.SessionStorage.ISessionStorageService SessionStorage

<ClientAuthGuard>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">

                <h3 class="fw-bold text-primary">
                    <i class="bi bi-person-circle me-2"></i>Hồ sơ của tôi
                </h3>
                <p class="text-muted">Quản lý thông tin hồ sơ để bảo mật tài khoản.</p>

                <div class="card border-0 shadow-sm rounded-4 overflow-hidden">

                    <div class="card-header bg-white border-bottom-0 p-0">
                        <ul class="nav nav-tabs nav-fill">

                            <li class="nav-item">
                                <button class="nav-link @(activeTab == "info" ? "active" : "") fw-bold py-3"
                                        @onclick="@(() => activeTab = "info")">
                                    <i class="bi bi-person-vcard me-2"></i>Thông tin cá nhân
                                </button>
                            </li>

                            <li class="nav-item">
                                <button class="nav-link @(activeTab == "password" ? "active" : "") fw-bold py-3"
                                        @onclick="@(() => activeTab = "password")">
                                    <i class="bi bi-shield-lock me-2"></i>Đổi mật khẩu
                                </button>
                            </li>

                        </ul>
                    </div>

                    <div class="card-body p-4 p-md-5">

                        @if (activeTab == "info")
                        {
                            <EditForm Model="@personalInfoModel" OnValidSubmit="HandleSavePersonalInfo">
                                <DataAnnotationsValidator />
                                <ValidationSummary />

                                <div class="mb-3">
                                    <label class="form-label fw-semibold text-secondary small">Họ và tên</label>
                                    <InputText class="form-control" @bind-Value="personalInfoModel.FullName" />
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-semibold text-secondary small">Số điện thoại</label>
                                        <InputText class="form-control" @bind-Value="personalInfoModel.Phone" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-semibold text-secondary small">Email</label>
                                        <InputText class="form-control bg-light" @bind-Value="personalInfoModel.Email" readonly />
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold text-secondary small">Địa chỉ</label>
                                    <InputTextArea class="form-control" @bind-Value="personalInfoModel.Address" rows="3" />
                                </div>

                                <div class="d-flex justify-content-end">
                                    <button class="btn btn-primary px-4 py-2 rounded-3">
                                        <i class="bi bi-save me-2"></i>Lưu thay đổi
                                    </button>
                                </div>

                                @if (!string.IsNullOrEmpty(infoMessage))
                                {
                                    <div class="mt-3 alert alert-@infoMessageType">@infoMessage</div>
                                }
                            </EditForm>
                        }

                        @if (activeTab == "password")
                        {
                            <EditForm Model="@changePasswordModel" OnValidSubmit="HandleChangePassword">
                                <DataAnnotationsValidator />
                                <ValidationSummary />

                                <div class="mb-3">
                                    <label class="form-label fw-semibold small">Mật khẩu hiện tại</label>
                                    <InputText type="password" class="form-control"
                                               @bind-Value="changePasswordModel.CurrentPassword" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold small">Mật khẩu mới</label>
                                    <InputText type="password" class="form-control"
                                               @bind-Value="changePasswordModel.NewPassword" />
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-semibold small">Xác nhận mật khẩu mới</label>
                                    <InputText type="password" class="form-control"
                                               @bind-Value="changePasswordModel.ConfirmPassword" />
                                </div>

                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary py-2 rounded-3">Xác nhận đổi mật khẩu</button>
                                    <button type="button" class="btn btn-outline-secondary py-2 rounded-3"
                                            @onclick="ResetPasswordForm">
                                        Hủy bỏ
                                    </button>
                                </div>

                                @if (!string.IsNullOrEmpty(passwordMessage))
                                {
                                    <div class="mt-3 alert alert-@passwordMessageType">@passwordMessage</div>
                                }
                            </EditForm>
                        }

                    </div>

                </div>
            </div>
        </div>
    </div>
</ClientAuthGuard>

@code {
    private string activeTab = "info";

    private PersonalInfoDTO personalInfoModel = new();
    private ChangePasswordDTO changePasswordModel = new();

    private string infoMessage = "";
    private string infoMessageType = "success";

    private string passwordMessage = "";
    private string passwordMessageType = "success";

    private bool _loaded = false;

    // ⭐ Load userId từ SessionStorage (login đã lưu)
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _loaded)
            return;

        // Lấy email từ session
        var email = await SessionStorage.GetItemAsync<string>("userName");

        if (!string.IsNullOrEmpty(email))
        {
            // Tìm Customer trong DB
            personalInfoModel = await personalInfoService.GetPersonalInfoAsync(email);
        }

        _loaded = true;
        await InvokeAsync(StateHasChanged);
    }


    private async Task HandleSavePersonalInfo()
    {
        var result = await personalInfoService.UpdatePersonalInfoAsync(personalInfoModel);

        infoMessageType = result.Type;
        infoMessage = result.Message;

        // Render ngay
        await InvokeAsync(StateHasChanged);

        if (result.Type == "success")
        {
            _ = Task.Run(async () =>
            {
                await Task.Delay(5000);
                infoMessage = "";
                await InvokeAsync(StateHasChanged);
            });
        }
    }

    private async Task HandleChangePassword()
    {
        var userId = await SessionStorage.GetItemAsync<int>("userId");
        var result = await personalInfoService.ChangePasswordAsync(userId, changePasswordModel);

        passwordMessageType = result.Type;
        passwordMessage = result.Message;

        // Render NGAY để hiển thị thông báo
        await InvokeAsync(StateHasChanged);

        if (result.Type == "success")
        {
            // Reset form
            changePasswordModel = new ChangePasswordDTO();

            // Chạy task nền để xóa message sau 5 giây
            _ = Task.Run(async () =>
            {
                await Task.Delay(5000);
                passwordMessage = "";
                await InvokeAsync(StateHasChanged);
            });
        }
    }


    private void ResetPasswordForm()
    {
        changePasswordModel = new ChangePasswordDTO();
    }
}