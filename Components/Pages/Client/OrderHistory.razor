@page "/client/orderHistory"
@using StoreBlazor.Components.Layout.Client
@layout ClientLayout
@rendermode InteractiveServer

<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="fw-bold text-primary">
                <i class="bi bi-clock-history me-2"></i>Lịch sử đơn hàng
            </h3>
            <p class="text-muted">Theo dõi và quản lý các đơn hàng của bạn.</p>
        </div>
    </div>
    @* Thanh lọc, tìm kiếm đơn hàng *@
    <div class="row mb-4 g-3 align-items-center">
        <!-- Bộ lọc trạng thái -->
        <div class="col-auto d-flex align-items-center">
            <select class="form-select">
                <option value="">Tất cả trạng thái</option>
                <option value="processing">Đang xử lý</option>
                <option value="shipping">Đang giao</option>
                <option value="completed">Hoàn thành</option>
                <option value="cancelled">Đã hủy</option>
            </select>
        </div>

        <!-- Ô tìm kiếm -->
        <div class="col-auto d-flex align-items-center flex-grow-1">
            <div class="input-group flex-grow-1">
                <input type="text" class="form-control" placeholder="Tìm theo mã đơn hàng...">
                <button class="btn btn-primary">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        @* Table danh sách đơn hàng *@
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr class="text-black">
                        <th class="py-3 text-center">Mã đơn hàng</th>
                        <th class="py-3 text-center ">Ngày đặt</th>
                        <th class="py-3 text-center">Tổng tiền</th>
                        <th class="py-3 text-center">Trạng thái</th>
                        <th class="py-3 text-center pe-4 ">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (orders == null || orders.Count == 0)
                    {
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                Bạn chưa có đơn hàng nào.
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var order in orders)
                        {
                            <tr>
                                <td class="ps-4 fw-bold text-primary text-center">#@order.Code</td>
                                <td class="text-center">@order.OrderDate.ToString("dd/MM/yyyy HH:mm")</td>
                                <td class="fw-bold text-center">@order.TotalAmount.ToString("N0")đ</td>
                                <td class="text-center">
                                    <span class="badge @GetStatusBadgeClass(order.Status) rounded-pill px-3 py-2 border">
                                        @GetStatusLabel(order.Status)
                                    </span>
                                </td>
                                <td class="text-center pe-4">
                                    <button class="btn btn-sm btn-outline-primary me-2" @onclick="() => OpenDetailModal(order)" title="Xem chi tiết">
                                        <i class="bi bi-eye"></i>
                                    </button>

                                    @if (order.Status == OrderStatus.Pending)
                                    {
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => CancelOrder(order.Id)" title="Hủy đơn hàng">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
@* Modal xem chi tiết đơn hàng *@
@if (selectedOrder != null)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
            <div class="modal-content border-0 rounded-4">
                <div class="modal-header border-0 bg-light rounded-top-4">
                    <h5 class="modal-title fw-bold text-primary">
                        Chi tiết đơn hàng #@selectedOrder.Code
                    </h5>
                    <button type="button" class="btn-close" @onclick="() => selectedOrder = null"></button>
                </div>

                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-light rounded-3">
                        <div>
                            <small class="text-muted d-block">Ngày đặt hàng</small>
                            <span class="fw-bold">@selectedOrder.OrderDate.ToString("dd/MM/yyyy HH:mm")</span>
                        </div>
                        <div class="text-end">
                            <small class="text-muted d-block">Trạng thái</small>
                            <span class="badge @GetStatusBadgeClass(selectedOrder.Status) text-dark-emphasis">
                                @GetStatusLabel(selectedOrder.Status)
                            </span>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="fw-bold border-bottom pb-2 mb-3">Thông tin giao hàng</h6>
                            <p class="mb-1"><strong>Người nhận:</strong> @selectedOrder.ShippingName</p>
                            <p class="mb-1"><strong>SĐT:</strong> @selectedOrder.ShippingPhone</p>
                            <p class="mb-0"><strong>Địa chỉ:</strong> @selectedOrder.ShippingAddress</p>
                        </div>
                        <div class="col-md-6 mt-3 mt-md-0">
                            <h6 class="fw-bold border-bottom pb-2 mb-3">Thanh toán</h6>
                            <p class="mb-1"><strong>Phương thức:</strong> @selectedOrder.PaymentMethod</p>
                            <p class="mb-1"><strong>Tiền sản phẩm:</strong>10.000 đ</p>
                            <p class="mb-1"><strong>Tiền giảm: </strong>10.000 đ</p>
                        </div>
                    </div>
                    @* Danh sách sản phẩm trong chi tiết đơn hàng *@
                    <h6 class="fw-bold border-bottom pb-2 mb-3">Sản phẩm đã mua</h6>
                    <div class="list-group list-group-flush mb-3">
                        @foreach (var detail in selectedOrder.Details)
                        {
                            <div class="list-group-item px-0 d-flex align-items-center">
                                <img src="@detail.ProductImage" class="rounded border me-3" style="width: 60px; height: 60px; object-fit: cover;">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0 small fw-bold">@detail.ProductName</h6>
                                    <small class="text-muted">x @detail.Quantity</small>
                                </div>
                                <div class="text-end fw-bold">
                                    @((detail.Price * detail.Quantity).ToString("N0"))đ
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <div class="modal-footer border-top bg-light rounded-bottom-4 justify-content-between">
                    <div class="fs-5">
                        Tổng cộng: <strong class="text-primary">@selectedOrder.TotalAmount.ToString("N0")đ</strong>
                    </div>
                    <button class="btn btn-secondary" @onclick="() => selectedOrder = null">Đóng</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // ENUM TRẠNG THÁI 
    public enum OrderStatus
    {
        Pending,  
        Paid, 
        Cancelled  
    }

    // MODELS 
    public class OrderDetail
    {
        public string ProductName { get; set; } = "";
        public string ProductImage { get; set; } = "";
        public int Quantity { get; set; }
        public decimal Price { get; set; }
    }

    public class Order
    {
        public int Id { get; set; }
        public string Code { get; set; } = ""; 
        public DateTime OrderDate { get; set; }
        public decimal TotalAmount { get; set; }
        public OrderStatus Status { get; set; }

        // Info người nhận
        public string ShippingName { get; set; } = "";
        public string ShippingPhone { get; set; } = "";
        public string ShippingAddress { get; set; } = "";
        public string PaymentMethod { get; set; } = "";
        public string Note { get; set; } = "";

        public List<OrderDetail> Details { get; set; } = new();
    }

    //  LOGIC
    private List<Order> orders = new List<Order>();
    private Order? selectedOrder = null;

    protected override void OnInitialized()
    {
        // Tạo dữ liệu giả
        orders = new List<Order>
        {
            new Order
            {
                Id = 1, Code = "ORD-8821", OrderDate = DateTime.Now.AddDays(-1), TotalAmount = 1550000, Status = OrderStatus.Pending,
                ShippingName = "Nguyễn Văn A", ShippingPhone = "0909123456", ShippingAddress = "123 Đường Láng, Hà Nội", PaymentMethod = "COD",
                Details = new List<OrderDetail>
                {
                    new OrderDetail { ProductName = "Sách Clean Architecture", Quantity = 1, Price = 350000, ProductImage = "/uploads/SP_2577b44d52004619b75dd96cf1c4cb8e.jpg" },
                    new OrderDetail { ProductName = "Bút máy Parker", Quantity = 1, Price = 1200000, ProductImage = "/uploads/SP_2577b44d52004619b75dd96cf1c4cb8e.jpg" }
                }
            },
            new Order
            {
                Id = 2, Code = "ORD-7712", OrderDate = DateTime.Now.AddDays(-5), TotalAmount = 85000, Status = OrderStatus.Paid,
                ShippingName = "Nguyễn Văn A", ShippingPhone = "0909123456", ShippingAddress = "123 Đường Láng, Hà Nội", PaymentMethod = "VNPAY",
                Details = new List<OrderDetail>
                {
                    new OrderDetail { ProductName = "Vở học sinh (Lốc 10)", Quantity = 1, Price = 85000, ProductImage = "/uploads/SP_2577b44d52004619b75dd96cf1c4cb8e.jpg" }
                }
            },
            new Order
            {
                Id = 3, Code = "ORD-6633", OrderDate = DateTime.Now.AddDays(-10), TotalAmount = 500000, Status = OrderStatus.Cancelled,
                ShippingName = "Nguyễn Văn A", ShippingPhone = "0909123456", ShippingAddress = "123 Đường Láng, Hà Nội", PaymentMethod = "COD",
                Details = new List<OrderDetail>
                {
                    new OrderDetail { ProductName = "Balo chống gù", Quantity = 1, Price = 500000, ProductImage = "/uploads/SP_2577b44d52004619b75dd96cf1c4cb8e.jpg" }
                }
            }
        };
    }

    private void OpenDetailModal(Order order)
    {
        selectedOrder = order;
    }

    private void CancelOrder(int orderId)
    {
        var order = orders.FirstOrDefault(o => o.Id == orderId);
        if (order != null)
        {
            order.Status = OrderStatus.Cancelled;
        }
    }


    // Lấy màu badge dựa trên trạng thái
    private string GetStatusBadgeClass(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Pending => "bg-warning-subtle text-warning-emphasis border-warning-subtle", // Vàng nhạt
            OrderStatus.Paid => "bg-info-subtle text-info-emphasis border-info-subtle", // Xanh dương nhạt
            OrderStatus.Cancelled => "bg-danger-subtle text-danger-emphasis border-danger-subtle", // Đỏ nhạt
            _ => "bg-secondary"
        };
    }

    // Lấy tên hiển thị tiếng Việt
    private string GetStatusLabel(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Pending => "Chờ xử lý",
            OrderStatus.Paid => "Đã thanh toán",
            OrderStatus.Cancelled => "Đã hủy",
            _ => "Không rõ"
        };
    }
}