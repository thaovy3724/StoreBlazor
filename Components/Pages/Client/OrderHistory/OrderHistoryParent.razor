@page "/client/orderHistory"
@using StoreBlazor.Components.Layout.Client
@layout ClientLayout
@rendermode InteractiveServer

<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="fw-bold text-primary">
                <i class="bi bi-clock-history me-2"></i>Lịch sử đơn hàng
            </h3>
            <p class="text-muted">Theo dõi và quản lý các đơn hàng của bạn.</p>
        </div>
    </div>
   
    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        @* Table danh sách đơn hàng *@
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr class="text-black">
                        <th class="py-3 text-center">Mã đơn hàng</th>
                        <th class="py-3 text-center ">Ngày đặt</th>
                        <th class="py-3 text-center">Tổng tiền</th>
                        <th class="py-3 text-center">Trạng thái</th>
                        <th class="py-3 text-center pe-4 ">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (orders == null || orders.Count == 0)
                    {
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                Bạn chưa có đơn hàng nào.
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var order in orders)
                        {
                            <tr>
                                <td class="ps-4 fw-bold text-primary text-center">#@order.Code</td>
                                <td class="text-center">@order.OrderDate.ToString("dd/MM/yyyy HH:mm")</td>
                                <td class="fw-bold text-center">@order.TotalAmount.ToString("N0")đ</td>
                                <td class="text-center">
                                    <span class="badge @GetStatusBadgeClass(order.Status) rounded-pill px-3 py-2 border">
                                        @GetStatusLabel(order.Status)
                                    </span>
                                </td>
                                <td class="text-center pe-4">
                                    <button class="btn btn-sm btn-outline-primary me-2" @onclick="() => OpenDetailModal(order)" title="Xem chi tiết">
                                        <i class="bi bi-eye"></i>
                                    </button>

                                    @if (order.Status == OrderStatus.Pending)
                                    {
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => CancelOrder(order.Id)" title="Hủy đơn hàng">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
@* Modal xem chi tiết đơn hàng *@
@if (selectedOrder != null)
{
    <_OrderHistoryDetailModal/>
}

@code {
    // ENUM TRẠNG THÁI 
    public enum OrderStatus
    {
        Pending,  
        Paid, 
        Cancelled  
    }

    // MODELS 
    public class OrderDetail
    {
        public string ProductName { get; set; } = "";
        public string ProductImage { get; set; } = "";
        public int Quantity { get; set; }
        public decimal Price { get; set; }
    }

    public class Order
    {
        public int Id { get; set; }
        public string Code { get; set; } = ""; 
        public DateTime OrderDate { get; set; }
        public decimal TotalAmount { get; set; }
        public OrderStatus Status { get; set; }

        // Info người nhận
        public string ShippingName { get; set; } = "";
        public string ShippingPhone { get; set; } = "";
        public string ShippingAddress { get; set; } = "";
        public string PaymentMethod { get; set; } = "";
        public string Note { get; set; } = "";

        public List<OrderDetail> Details { get; set; } = new();
    }

    //  LOGIC
    private List<Order> orders = new List<Order>();
    private Order? selectedOrder = null;

    protected override void OnInitialized()
    {
        // Tạo dữ liệu giả
        orders = new List<Order>
        {
            new Order
            {
                Id = 1, Code = "ORD-8821", OrderDate = DateTime.Now.AddDays(-1), TotalAmount = 1550000, Status = OrderStatus.Pending,
                ShippingName = "Nguyễn Văn A", ShippingPhone = "0909123456", ShippingAddress = "123 Đường Láng, Hà Nội", PaymentMethod = "COD",
                Details = new List<OrderDetail>
                {
                    new OrderDetail { ProductName = "Sách Clean Architecture", Quantity = 1, Price = 350000, ProductImage = "/uploads/SP_2577b44d52004619b75dd96cf1c4cb8e.jpg" },
                    new OrderDetail { ProductName = "Bút máy Parker", Quantity = 1, Price = 1200000, ProductImage = "/uploads/SP_2577b44d52004619b75dd96cf1c4cb8e.jpg" }
                }
            },
            new Order
            {
                Id = 2, Code = "ORD-7712", OrderDate = DateTime.Now.AddDays(-5), TotalAmount = 85000, Status = OrderStatus.Paid,
                ShippingName = "Nguyễn Văn A", ShippingPhone = "0909123456", ShippingAddress = "123 Đường Láng, Hà Nội", PaymentMethod = "VNPAY",
                Details = new List<OrderDetail>
                {
                    new OrderDetail { ProductName = "Vở học sinh (Lốc 10)", Quantity = 1, Price = 85000, ProductImage = "/uploads/SP_2577b44d52004619b75dd96cf1c4cb8e.jpg" }
                }
            },
            new Order
            {
                Id = 3, Code = "ORD-6633", OrderDate = DateTime.Now.AddDays(-10), TotalAmount = 500000, Status = OrderStatus.Cancelled,
                ShippingName = "Nguyễn Văn A", ShippingPhone = "0909123456", ShippingAddress = "123 Đường Láng, Hà Nội", PaymentMethod = "COD",
                Details = new List<OrderDetail>
                {
                    new OrderDetail { ProductName = "Balo chống gù", Quantity = 1, Price = 500000, ProductImage = "/uploads/SP_2577b44d52004619b75dd96cf1c4cb8e.jpg" }
                }
            }
        };
    }

    private void OpenDetailModal(Order order)
    {
        selectedOrder = order;
    }

    private void CancelOrder(int orderId)
    {
        var order = orders.FirstOrDefault(o => o.Id == orderId);
        if (order != null)
        {
            order.Status = OrderStatus.Cancelled;
        }
    }


    // Lấy màu badge dựa trên trạng thái
    private string GetStatusBadgeClass(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Pending => "bg-warning-subtle text-warning-emphasis border-warning-subtle", // Vàng nhạt
            OrderStatus.Paid => "bg-info-subtle text-info-emphasis border-info-subtle", // Xanh dương nhạt
            OrderStatus.Cancelled => "bg-danger-subtle text-danger-emphasis border-danger-subtle", // Đỏ nhạt
            _ => "bg-secondary"
        };
    }

    // Lấy tên hiển thị tiếng Việt
    private string GetStatusLabel(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Pending => "Chờ xử lý",
            OrderStatus.Paid => "Đã thanh toán",
            OrderStatus.Cancelled => "Đã hủy",
            _ => "Không rõ"
        };
    }
}