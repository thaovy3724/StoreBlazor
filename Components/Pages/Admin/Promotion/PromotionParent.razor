@page "/admin/promotion"
@layout AdminLayout
@inject IPromotionService service
@inherits BaseParent<Promotion>

<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold">Quản lý khuyến mãi</h3>
    </div>

    <div class="d-flex justify-content-between align-items-start mb-3 flex-wrap gap-2">
        <!-- Thanh lọc bên trái -->
        <PromotionFilter/>
        <!-- Nút Thêm mới bên phải -->
        <button class="btn btn-primary btn-sm btn-add" data-bs-toggle="modal" data-bs-target="#promotionModal" data-action="view_add">
            <i class="bi bi-plus-circle"></i> Thêm mới
        </button>
    </div>

    @* Bảng dữ liệu *@
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered align-middle">
                    <thead class="table-light thead-separator">
                        <tr class="text-center align-middle">
                            <th style="width:120px;">Mã</th>
                            <th>Giá trị đơn hàng tối thiểu</th>
                            <th>Loại</th>
                            <th>Giới hạn lần sử dụng</th>
                            <th>Ngày bắt đầu</th>
                            <th>Ngày kết thúc</th>
                            <th>Trạng thái</th>
                            <th style="width:150px;">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (listResult != null && listResult.Any())
                        {
                            foreach (var item in listResult)
                            {
                                <tr data-id="@item.PromoId">
                                    <td>@item.PromoCode</td>
                                    <td>@item.MinOrderAmount.ToString("N0") đ</td>
                                    <td>@item.DiscountType.ToString()</td>
                                    <td>@item.UsageLimit</td>
                                    <td>@item.StartDate.ToString("dd/MM/yyyy")</td>
                                    <td>@item.EndDate.ToString("dd/MM/yyyy")</td>
                                    <td class="text-center">
                                        @if (item.Status == PromotionStatus.Active)
                                        {
                                            <span class="badge rounded-pill px-3 py-2 fw-semibold"
                                                  style="background-color:#0d6efd1a; color:#0d6efd; border:1px solid #0d6efd;">
                                                Hoạt động
                                            </span>
                                        }
                                        else if (item.Status == PromotionStatus.Inactive)
                                        {
                                            <span class="badge rounded-pill px-3 py-2 fw-semibold"
                                                  style="background-color:#ffc1071a; color:#b8860b; border:1px solid #ffc107;">
                                                Bị khóa
                                            </span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <button data-id="@item.PromoId" 
                                                class="btn btn-sm btn-light border me-1 btn-view" 
                                                title="Xem" data-bs-toggle="modal" 
                                                data-bs-target="#promotionModal" 
                                                data-action="view"
                                                @onclick="() => OpenDetailForm(item)">
                                            <i class="bi bi-eye text-primary"></i>
                                        </button>
                                        <button data-id="@item.PromoId" 
                                                class="btn btn-sm btn-light border me-1 btn-edit" 
                                                title="Sửa" data-bs-toggle="modal" 
                                                data-bs-target="#promotionModal" 
                                                data-action="view_edit"
                                                @onclick="() => OpenEditForm(item)">
                                            <i class="bi bi-pencil text-success"></i>
                                        </button>
                                        @if (item.Status == PromotionStatus.Active)
                                        {
                                            <button data-id="@item.PromoId"
                                                    class="btn btn-sm btn-light border me-1 btn-lock"
                                                    title="Khóa/ Mở khóa"
                                                    @onclick="() => HandleLockAsync(item)">
                                                <i class="bi bi-unlock text-primary"></i>
                                            </button>
                                        }
                                        else if (item.Status == PromotionStatus.Inactive)
                                        {
                                            <button data-id="@item.PromoId"
                                                    class="btn btn-sm btn-light border me-1 btn-lock"
                                                    title="Khóa/ Mở khóa"
                                                    @onclick="() => HandleLockAsync(item)">
                                                <i class="bi bi-lock text-primary"></i>
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" class="text-center text-muted">Không có dữ liệu</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Phân trang -->
            <Pagination/>
        </div>
    </div>
</div>

<!-- Modal dùng chung -->
<PromotionForm  Model ="@SelectedItem"
                IsEditMode = "@IsEditMode"
                IsDetailMode="@IsDetailMode"
                OnSave="HandleSaveAsync"
                OnClose="CloseForm"/>
@code {
    // ==== VARIABLES ====
    private List<Promotion> listResult = new();
    private ServiceResult serviceResult = new();

    // ==== LOAD DATA ====
    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }
    private async Task LoadDataAsync()
    {
        // load data
        listResult = await service.GetAllPromotionAsync();

        // pagination

    }
    // ==== OPEN EDIT FORM ====
    private void OpenEditForm(Promotion item)
    {
        IsEditMode = true;
        SelectedItem = new Promotion
        {
            PromoId = item.PromoId,
            PromoCode = item.PromoCode,
            DiscountType = item.DiscountType,
            DiscountValue = item.DiscountValue,
            MinOrderAmount = item.MinOrderAmount,
            UsageLimit = item.UsageLimit,
            StartDate = item.StartDate,
            EndDate = item.EndDate,
            Status = item.Status,
            Description = item.Description
        };
    }
    // === OPEN DETAIL FORM ===
    private void OpenDetailForm(Promotion item)
    {
        IsEditMode = false;
        IsDetailMode = true;
        SelectedItem = item;
    }

    // === SAVE DATA ====
    private async Task HandleSaveAsync(Promotion model)
    {
        if (IsEditMode)
        {
            serviceResult = await service.UpdateAsync(model);
        }
        else
        {
            serviceResult = await service.CreateAsync(model);
        }
        await ShowAlertAsync(serviceResult);
        await LoadDataAsync();
    }
    // == LOCK PROMOTION ==
    private async Task HandleLockAsync(Promotion model)
    {
        string title = model.Status == PromotionStatus.Active
                        ? "Bạn có chắc muốn khóa khuyến mãi này?"
                        : "Bạn có chắc muốn mở khóa khuyến mãi này?";

        if (!await ConfirmLockAsync(title)) return;

        serviceResult = await service.LockAsync(model);
        await ShowAlertAsync(serviceResult);

        await LoadDataAsync();
    }
     // ==== SEARCH ====
    



}
