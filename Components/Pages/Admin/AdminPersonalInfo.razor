@page "/admin/profile"
@layout AdminLoginLayout
@using StoreBlazor.DTO.Admin
@inject IAdminPersonalInfoService AdminPersonalInfoService
@inject Blazored.SessionStorage.ISessionStorageService SessionStorage
@inject NavigationManager Nav

<AdminAuthGuard>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <h3 class="fw-bold text-primary">
                    <i class="bi bi-person-circle me-2"></i>Hồ sơ Admin
                </h3>
                <p class="text-muted">Quản lý thông tin hồ sơ để bảo mật tài khoản.</p>

                <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                    <div class="card-header bg-white border-bottom-0 p-0">
                        <ul class="nav nav-tabs nav-fill">
                            <li class="nav-item">
                                <button class="nav-link @(activeTab == "info" ? "active" : "") fw-bold py-3"
                                        type="button"
                                        @onclick="@(() => SetActiveTab("info"))">
                                    <i class="bi bi-person-vcard me-2"></i>Thông tin cá nhân
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link @(activeTab == "password" ? "active" : "") fw-bold py-3"
                                        type="button"
                                        @onclick="@(() => SetActiveTab("password"))">
                                    <i class="bi bi-shield-lock me-2"></i>Đổi mật khẩu
                                </button>
                            </li>
                        </ul>
                    </div>

                    <div class="card-body p-4 p-md-5">
                        @if (activeTab == "info")
                        {
                            <EditForm Model="@adminPersonalInfoModel" OnValidSubmit="HandleSavePersonalInfo">
                                <DataAnnotationsValidator />
                                <ValidationSummary />

                                <div class="mb-3">
                                    <label class="form-label fw-semibold text-secondary small">Họ và tên</label>
                                    <InputText class="form-control"
                                               @bind-Value="adminPersonalInfoModel.FullName" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold text-secondary small">Tên đăng nhập</label>
                                    <InputText class="form-control bg-light"
                                               @bind-Value="adminPersonalInfoModel.Username"
                                               readonly />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold text-secondary small">Vai trò</label>
                                    <InputText class="form-control bg-light"
                                               @bind-Value="adminPersonalInfoModel.Role"
                                               readonly />
                                </div>

                                <div class="d-flex justify-content-end">
                                    <button type="submit" class="btn btn-primary px-4 py-2 rounded-3">
                                        <i class="bi bi-save me-2"></i>Lưu thay đổi
                                    </button>
                                </div>

                                @if (!string.IsNullOrEmpty(infoMessage))
                                {
                                    <div class="mt-3 alert alert-@infoMessageType">
                                        @infoMessage
                                    </div>
                                }
                            </EditForm>
                        }

                        @if (activeTab == "password")
                        {
                            <EditForm Model="@adminChangePasswordModel" OnValidSubmit="HandleChangePassword">
                                <DataAnnotationsValidator />
                                <ValidationSummary />

                                <div class="mb-3">
                                    <label class="form-label fw-semibold text-secondary small">Mật khẩu hiện tại</label>
                                    <InputText type="password"
                                               class="form-control"
                                               @bind-Value="adminChangePasswordModel.CurrentPassword" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold text-secondary small">Mật khẩu mới</label>
                                    <InputText type="password"
                                               class="form-control"
                                               @bind-Value="adminChangePasswordModel.NewPassword" />
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-semibold text-secondary small">Xác nhận mật khẩu mới</label>
                                    <InputText type="password"
                                               class="form-control"
                                               @bind-Value="adminChangePasswordModel.ConfirmPassword" />
                                </div>

                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary py-2 rounded-3">
                                        Xác nhận đổi mật khẩu
                                    </button>
                                    <button type="button"
                                            class="btn btn-outline-secondary py-2 rounded-3"
                                            @onclick="ResetPasswordForm">
                                        Hủy bỏ
                                    </button>
                                </div>

                                @if (!string.IsNullOrEmpty(passwordMessage))
                                {
                                    <div class="mt-3 alert alert-@passwordMessageType">
                                        @passwordMessage
                                    </div>
                                }
                            </EditForm>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</AdminAuthGuard>

@code {
    private string activeTab = "info";

    private AdminPersonalInfoDTO adminPersonalInfoModel = new();
    private AdminChangePasswordDTO adminChangePasswordModel = new();

    private string infoMessage = "";
    private string infoMessageType = "success"; // Bootstrap: success / danger / warning / info

    private string passwordMessage = "";
    private string passwordMessageType = "success";

    private int _adminId;
    private bool _loaded = false;

    // Blazor Server: dùng OnAfterRenderAsync + firstRender để gọi JSInterop (SessionStorage)
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _loaded)
            return;

        try
        {
            var id = await SessionStorage.GetItemAsync<int?>("adminId");
            Console.WriteLine($"[DEBUG] adminId in AdminProfile: {id}");

            if (id == null || id == 0)
            {
                Nav.NavigateTo("/admin/login", true);
                return;
            }

            _adminId = id.Value;

            var result = await AdminPersonalInfoService.GetPersonalInfoAsync(_adminId);
            if (result != null)
            {
                adminPersonalInfoModel = result;
            }

            _loaded = true;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ERROR] AdminProfile OnAfterRenderAsync: {ex.Message}");
            Nav.NavigateTo("/admin/login", true);
        }
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        // Xoá message khi đổi tab để UI sạch
        infoMessage = "";
        passwordMessage = "";
    }

    private async Task HandleSavePersonalInfo()
    {
        var result = await AdminPersonalInfoService.UpdatePersonalInfoAsync(_adminId, adminPersonalInfoModel);

        if (result.Type == "success")
        {
            infoMessageType = "success";
            infoMessage = result.Message ?? "Cập nhật thông tin thành công!";
        }
        else
        {
            infoMessageType = "danger";
            infoMessage = result.Message ?? "Cập nhật thất bại!";
        }
    }

    private async Task HandleChangePassword()
    {
        // Có thể check ConfirmPassword ở UI trước, nếu muốn
        if (adminChangePasswordModel.NewPassword != adminChangePasswordModel.ConfirmPassword)
        {
            passwordMessageType = "danger";
            passwordMessage = "Xác nhận mật khẩu không khớp!";
            return;
        }

        var result = await AdminPersonalInfoService.ChangePasswordAsync(_adminId, adminChangePasswordModel);

        if (result.Type == "success")
        {
            passwordMessageType = "success";
            passwordMessage = result.Message ?? "Đổi mật khẩu thành công!";
            adminChangePasswordModel = new AdminChangePasswordDTO();
        }
        else
        {
            passwordMessageType = "danger";
            passwordMessage = result.Message ?? "Đổi mật khẩu thất bại!";
        }
    }

    private void ResetPasswordForm()
    {
        adminChangePasswordModel = new AdminChangePasswordDTO();
    }
}
