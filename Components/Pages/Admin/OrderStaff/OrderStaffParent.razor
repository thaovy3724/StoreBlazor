@page "/admin/orderstaff"
@layout AdminLayout
@inject IOrderStaffService service
@inject IJSRuntime JS

<div class="container-fluid p-1 vh-100">
    <div class="row bg-white">
        <!-- ==================== COL TRÁI: SẢN PHẨM ==================== -->
        <div class="col-md-5 border-end d-flex flex-column">
            
            <!-- Thanh tìm kiếm + lọc -->
            <OrderStaffFilter Categories="@categories"
                              SelectedCategoryId="@selectedCategoryId"
                              SearchKeyword="@searchKeyword"
                              ShowScanner="@showScanner"
                              OnCategoryChange="HandleCategoryChange"
                              SearchKeywordChanged="(keyword) => searchKeyword = keyword"
                              OnSearch="() => LoadProductsAsync(1)"
                              OnScannerToggle="ToggleScanner"
                              OnBarcodeScanned="HandleBarcodeScanned" />

            <!-- Danh sách sản phẩm -->
            <div class="row g-3 flex-grow-1" style="overflow-y: auto;">
                @if (products != null && products.Any())
                {
                    foreach (var p in products)
                    {
                        <div class="col-4">
                            <div class="product-card d-flex flex-column h-100 justify-content-between"
                                 @onclick="() => AddToCart(p)" style="cursor: pointer;">

                                @if (!string.IsNullOrWhiteSpace(p.ProductImage))
                                {
                                    <img src="/uploads/@p.ProductImage"
                                         alt="@p.ProductName"
                                         class="img-fluid rounded mb-2" />
                                }
                                else
                                {
                                    <img src="/images/no-image.jpg"
                                         alt="No image"
                                         class="img-fluid rounded mb-2" />
                                }

                                <p class="mb-1 fw-semibold text-truncate" title="@p.ProductName">
                                    @p.ProductName
                                </p>

                                <span class="text-muted small d-block mb-2">
                                    Tồn kho: <strong class="text-success">@p.Quantity</strong>
                                </span>

                                <span class="product-price text-center">@p.Price.ToString("N0")đ</span>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12 text-center text-muted py-3">
                        Không có sản phẩm nào
                    </div>
                }
            </div>


            <!-- Phân trang -->
            <div class="mt-auto pt-2">
                <Pagination CurrentPage="@CurrentPage"
                            TotalPages="@TotalPages"
                            OnPageChange="LoadProductsAsync" />
            </div>
        </div>

        <!-- ==================== COL PHẢI: GIỎ HÀNG ==================== -->
        <div class="col-md-7">
            <h5 class="mt-3">Phiếu Hàng</h5>

            <!-- Bảng giỏ hàng -->
            <div class="cart-wrapper table-responsive" style="max-height: 350px; overflow-y: auto;">
                <table class="table table-bordered cart-table">
                    <thead class="table-light">
                        <tr class="text-center">
                            <th style="width: 50px;"></th>
                            <th>Sản phẩm</th>
                            <th>Đơn giá</th>
                            <th>Số lượng</th>
                            <th>Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (cartItems.Any())
                        {
                            foreach (var item in cartItems)
                            {
                                <tr>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-danger" @onclick="() => RemoveFromCart(item)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="/uploads/@item.ProductImage" 
                                                 style="width: 50px; height: 50px; object-fit: cover;" 
                                                 class="me-2 rounded">
                                            <span>@item.ProductName</span>
                                        </div>
                                    </td>
                                    <td class="text-center">@item.Price.ToString("N0")đ</td>
                                    <td class="text-center">
                                        <div class="input-group input-group-sm" style="width: 110px; margin: 0 auto;">
                                            <button class="btn btn-outline-secondary" @onclick="() => UpdateQuantity(item, -1)">-</button>
                                            <input type="text" class="form-control text-center" value="@item.Quantity" readonly>
                                            <button class="btn btn-outline-secondary" @onclick="() => UpdateQuantity(item, 1)">+</button>
                                        </div>
                                    </td>
                                    <td class="text-center fw-bold">@item.Subtotal.ToString("N0")đ</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    Giỏ hàng trống
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <hr class="my-3">

            <!-- Thông tin khách hàng + Thanh toán -->
            <div class="row">
                <!-- COL TRÁI: Khách hàng + Khuyến mãi -->
                <div class="col-md-6" style="border-right: 2px dashed #6c757d;">
                    <!-- Khách hàng -->
                    <div class="mb-3">
                        <label class="form-label fw-medium">Khách hàng</label>
                        <div class="input-group">
                            <input type="text" class="form-control" 
                                   placeholder="Nhập số điện thoại"
                                   @bind="customerPhone"
                                   @oninput="SearchCustomer">
                            <button class="btn btn-outline-primary" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#modalAddCustomer">
                                <i class="bi bi-person-plus"></i>
                            </button>
                        </div>
                        @if (selectedCustomer != null)
                        {
                            <div class="form-text text-secondary fst-italic mt-2">
                                <strong>@selectedCustomer.Name</strong> - @selectedCustomer.Phone
                                @if (!string.IsNullOrEmpty(selectedCustomer.Address))
                                {
                                    <br />@selectedCustomer.Address
                                }
                            </div>
                        }
                        
                        <!-- Autocomplete suggestions -->
                        @if (customerSuggestions.Any())
                        {
                            <div class="list-group position-absolute mt-1" style="z-index: 1000; max-width: 400px;">
                                @foreach (var cust in customerSuggestions)
                                {
                                    <button class="list-group-item list-group-item-action" 
                                            @onclick="() => SelectCustomer(cust)">
                                        <strong>@cust.Name</strong> - @cust.Phone
                                    </button>
                                }
                            </div>
                        }
                    </div>

                    <!-- Khuyến mãi -->
                    <div class="mb-3">
                        <label class="form-label fw-medium">Khuyến mãi</label>
                        <div class="input-group">
                            <input type="text" class="form-control" 
                                   placeholder="Chọn khuyến mãi..."
                                   value="@(selectedPromotion?.PromoCode ?? "")"
                                   readonly>
                            <button class="btn btn-outline-primary" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#modalPromotion"
                                    disabled="@(!cartItems.Any())">
                                <i class="bi bi-gift"></i>
                            </button>
                        </div>
                        @if (selectedPromotion != null)
                        {
                            <div class="form-text text-success fst-italic">
                                Giảm @DiscountAmount.ToString("N0")đ - @selectedPromotion.Description
                            </div>
                        }
                    </div>
                </div>

                <!-- COL PHẢI: Tổng tiền + Thanh toán -->
                <div class="col-md-6">
                    <div class="total-box">
                        <p>Tổng tiền hàng: <strong>@TotalAmount.ToString("N0")đ</strong></p>
                        <p>Khuyến mãi: <span class="text-danger">-@DiscountAmount.ToString("N0")đ</span></p>
                        <h5 class="text-danger">Thành tiền: <span>@FinalAmount.ToString("N0")đ</span></h5>

                        <button class="btn btn-primary w-100" 
                                data-bs-toggle="modal" 
                                data-bs-target="#modalPayment"
                                disabled="@(!cartItems.Any())">
                            <i class="bi bi-cash-coin me-2"></i> Thanh toán
                        </button>
                        <button class="btn btn-outline-danger w-100 mt-2" @onclick="ClearCart">
                            <i class="bi bi-x-circle me-2"></i> Hủy
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Form Modal -->
<OrderStaffForm Promotions="@promotions"
                TotalAmount="@TotalAmount"
                DiscountAmount="@DiscountAmount"
                FinalAmount="@FinalAmount"
                OnCustomerAdded="HandleCustomerAdded"
                OnPromotionSelected="HandlePromotionSelected"
                OnPaymentConfirmed="ProcessPayment" />
@code {
    // ===== STATE =====
    private List<ProductCardDto> products = new();
    private List<Category> categories = new();
    private List<CartItemDto> cartItems = new();
    private List<PromotionDto> promotions = new();
    private List<CustomerSuggestionDto> customerSuggestions = new();
    private CustomerSuggestionDto? selectedCustomer;
    private PromotionDto? selectedPromotion;

    private int? selectedCategoryId = -1;
    private string searchKeyword = string.Empty;
    private string customerPhone = string.Empty;
    private bool showScanner = false;

    private int CurrentPage = 1;
    private int TotalPages = 1;

    // ===== COMPUTED =====
    private decimal TotalAmount => cartItems.Sum(c => c.Subtotal);
    private decimal DiscountAmount => selectedPromotion?.CalculateDiscount(TotalAmount) ?? 0;
    private decimal FinalAmount => TotalAmount - DiscountAmount;

    // ===== LIFECYCLE =====
    protected override async Task OnInitializedAsync()
    {
        categories = await service.GetAllCategoriesAsync();
        promotions = await service.GetActivePromotionsAsync();
        await LoadProductsAsync(1);
    }

    // ===== PRODUCT METHODS =====
    private async Task LoadProductsAsync(int page)
    {
        var result = await service.GetProductsAsync(page, selectedCategoryId, searchKeyword);
        products = result.Items;
        CurrentPage = page;
        TotalPages = result.TotalPages;
    }

    private async Task HandleCategoryChange(int? categoryId)
    {
        selectedCategoryId = categoryId;
        await LoadProductsAsync(1);
    }

    // ===== SCANNER =====
    private void ToggleScanner()
    {
        showScanner = !showScanner;
    }

    private async Task HandleBarcodeScanned(string barcode)
    {
        var product = await service.GetProductByBarcodeAsync(barcode);

        if (product != null)
        {
            AddToCart(product);
            await JS.InvokeVoidAsync("showAlert", "Đã thêm sản phẩm", "success");
        }
        else
        {
            await JS.InvokeVoidAsync("showAlert", "Không tìm thấy sản phẩm", "error");
        }
    }

    // ===== CART METHODS =====
    private void AddToCart(ProductCardDto product)
    {
        var existingItem = cartItems.FirstOrDefault(c => c.ProductId == product.ProductId);

        if (existingItem != null)
        {
            if (existingItem.Quantity < existingItem.StockQuantity)
            {
                existingItem.Quantity++;
            }
            else
            {
                JS.InvokeVoidAsync("showAlert", "Không đủ hàng trong kho", "warning");
            }
        }
        else
        {
            cartItems.Add(new CartItemDto
            {
                ProductId = product.ProductId,
                ProductName = product.ProductName,
                ProductImage = product.ProductImage,
                Price = product.Price,
                Quantity = 1,
                StockQuantity = product.Quantity
            });
        }
    }

    private void UpdateQuantity(CartItemDto item, int change)
    {
        item.Quantity += change;

        if (item.Quantity < 1) item.Quantity = 1;
        if (item.Quantity > item.StockQuantity)
        {
            item.Quantity = item.StockQuantity;
            JS.InvokeVoidAsync("showAlert", "Không đủ hàng trong kho", "warning");
        }
    }

    private void RemoveFromCart(CartItemDto item)
    {
        cartItems.Remove(item);
    }

    private void ClearCart()
    {
        cartItems.Clear();
        selectedCustomer = null;
        selectedPromotion = null;
        customerPhone = string.Empty;
    }

    // ===== CUSTOMER METHODS =====
    private async Task SearchCustomer()
    {
        if (string.IsNullOrWhiteSpace(customerPhone))
        {
            customerSuggestions.Clear();
            selectedCustomer = null;
            return;
        }
        await JS.InvokeVoidAsync("console.log", customerSuggestions);
        customerSuggestions = await service.SearchCustomerAsync(customerPhone);
    }

    private void SelectCustomer(CustomerSuggestionDto customer)
    {
        selectedCustomer = customer;
        customerPhone = customer.Phone;
        customerSuggestions.Clear();
    }

    private async Task HandleCustomerAdded(Customer customer)
    {
        var result = await service.CreateCustomerAsync(customer);
        await JS.InvokeVoidAsync("showAlert", result.Message, result.Type);

        if (result.Type == "success")
        {
            // Tự động chọn khách vừa thêm
            selectedCustomer = new CustomerSuggestionDto
            {
                CustomerId = customer.CustomerId,
                Name = customer.Name,
                Phone = customer.Phone ?? "",
                Email = customer.Email,
                Address = customer.Address
            };
            customerPhone = customer.Phone ?? "";
        }
    }

    // ===== PROMOTION METHODS =====
    private void HandlePromotionSelected(PromotionDto? promotion)
    {
        selectedPromotion = promotion;
    }

    // ===== PAYMENT =====
    private async Task ProcessPayment(PaymentMethod paymentMethod)
    {
        var orderDto = new OrderCreateDto
        {
            CustomerId = selectedCustomer?.CustomerId,
            PromoId = selectedPromotion?.PromoId,
            TotalAmount = TotalAmount,
            DiscountAmount = DiscountAmount,
            PaymentMethod = paymentMethod,
            Items = cartItems.Select(c => new OrderItemCreateDto
            {
                ProductId = c.ProductId,
                ProductName = c.ProductName,
                Quantity = c.Quantity,
                Price = c.Price
            }).ToList()
        };

        // TODO: Get userId from session/auth
        int userId = 1;

        var result = await service.CreateOrderAsync(orderDto, userId);
        await JS.InvokeVoidAsync("showAlert", result.Message, result.Type);

        if (result.Type == "success")
        {
            ClearCart();
            await LoadProductsAsync(CurrentPage);
        }
    }
}