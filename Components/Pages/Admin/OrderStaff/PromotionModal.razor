@inject IJSRuntime JS

<div class="modal fade" id="modalPromotion" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Danh sách khuyến mãi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr class="text-center">
                            <th style="width: 50px;">Chọn</th>
                            <th>Mã KM</th>
                            <th>Mô tả</th>
                            <th>Đơn tối thiểu</th>
                            <th>Giá trị</th>
                            <th>Hết hạn</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var validPromotions = Promotions.Where(p => p.IsApplicable(TotalAmount)).ToList();
                            var invalidPromotions = Promotions.Where(p => !p.IsApplicable(TotalAmount)).ToList();
                        }

                        @if (validPromotions.Any())
                        {
                            <tr>
                                <td colspan="6" class="text-start fw-bold p-2" style="background-color:#e8f5e9; border-bottom:2px solid #c8e6c9;">
                                    Khuyến mãi hợp lệ
                                </td>
                            </tr>
                            @foreach (var promo in validPromotions)
                            {
                                <tr>
                                    <td class="text-center">
                                        <input type="radio" name="selectedPromo"
                                               value="@promo.PromoId"
                                               checked="@(TempSelectedPromoId == promo.PromoId)"
                                               @onchange="() => TempSelectedPromoId = promo.PromoId">
                                    </td>
                                    <td>@promo.PromoCode</td>
                                    <td>@promo.Description</td>
                                    <td>@promo.MinOrderAmount.ToString("N0")đ</td>
                                    <td>
                                        @if (promo.DiscountType == DiscountType.Percent)
                                        {
                                            <span>@promo.DiscountValue%</span>
                                        }
                                        else
                                        {
                                            <span>@promo.DiscountValue.ToString("N0")đ</span>
                                        }
                                    </td>
                                    <td>@promo.EndDate.ToString("dd/MM/yyyy")</td>
                                </tr>
                            }
                        }

                        @if (invalidPromotions.Any())
                        {
                            <tr>
                                <td colspan="6" class="text-start fw-bold p-2" style="background-color:#f5f5f5; border-bottom:2px solid #dcdcdc;">
                                    Khuyến mãi chưa đủ điều kiện
                                </td>
                            </tr>
                            @foreach (var promo in invalidPromotions)
                            {
                                <tr class="table-secondary" title="Đơn hàng chưa đủ @promo.MinOrderAmount.ToString("N0")đ">
                                    <td class="text-center">
                                        <input type="radio" name="selectedPromo"
                                               value="@promo.PromoId"
                                               disabled>
                                    </td>
                                    <td>@promo.PromoCode</td>
                                    <td>@promo.Description</td>
                                    <td>@promo.MinOrderAmount.ToString("N0")đ</td>
                                    <td>
                                        @if (promo.DiscountType == DiscountType.Percent)
                                        {
                                            <span>@promo.DiscountValue%</span>
                                        }
                                        else
                                        {
                                            <span>@promo.DiscountValue.ToString("N0")đ</span>
                                        }
                                    </td>
                                    <td>@promo.EndDate.ToString("dd/MM/yyyy")</td>
                                </tr>
                            }
                        }

                        @if (!validPromotions.Any() && !invalidPromotions.Any())
                        {
                            <tr>
                                <td colspan="6" class="text-center text-muted py-3">
                                    Không có khuyến mãi nào
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" @onclick="ApplyPromotion">
                    Áp dụng
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public List<PromotionDto> Promotions { get; set; } = new();
    [Parameter] public decimal TotalAmount { get; set; }
    [Parameter] public EventCallback<PromotionDto?> OnPromotionSelected { get; set; }

    private int? TempSelectedPromoId;

    private async Task ApplyPromotion()
    {
        var selectedPromo = Promotions.FirstOrDefault(p => p.PromoId == TempSelectedPromoId);
        await OnPromotionSelected.InvokeAsync(selectedPromo);
        await JS.InvokeVoidAsync("hideModal", "modalPromotion");
    }
}